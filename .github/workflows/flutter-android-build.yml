name: Flutter Android CI/CD

on:
  push:
    branches:
      - "main"
      - "master"
      - "develop"
      - "claude/**"
    paths:
      - "flutter_app_storj_uploader/**"
      - ".github/workflows/flutter-android-build.yml"
  pull_request:
    branches:
      - "main"
      - "master"
      - "develop"
    paths:
      - "flutter_app_storj_uploader/**"
      - ".github/workflows/flutter-android-build.yml"
  workflow_dispatch:

jobs:
  build-android:
    name: Build Flutter Android APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter_app_storj_uploader

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"
          cache: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0" "cmdline-tools;latest" || true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          API_BASE_URL=https://stjup2-backend-udm3tutq7eb7i.yellowplant-e4c48860.japaneast.azurecontainerapps.io
          APP_NAME=Storj Uploader
          APP_VERSION=1.0.0
          ENABLE_DEBUG_LOGGING=false
          ENABLE_AUTO_UPLOAD=true
          EOF

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze
        continue-on-error: true

      - name: Run Flutter tests
        run: flutter test
        continue-on-error: true

      - name: Build Debug APK
        run: flutter build apk --debug --verbose

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: flutter-app-debug
          path: flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      - name: Build Release APK
        run: flutter build apk --release --verbose

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: flutter-app-release
          path: flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Build APK with ABI splits
        run: flutter build apk --release --split-per-abi --verbose

      - name: Upload Split APKs
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: flutter-app-release-split
          path: flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-*-release.apk
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/flutter-v')
    needs: build-android
    defaults:
      run:
        working-directory: flutter_app_storj_uploader

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"
          cache: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0" || true

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          API_BASE_URL=https://stjup2-backend-udm3tutq7eb7i.yellowplant-e4c48860.japaneast.azurecontainerapps.io
          APP_NAME=Storj Uploader
          APP_VERSION=1.0.0
          ENABLE_DEBUG_LOGGING=false
          ENABLE_AUTO_UPLOAD=true
          EOF

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Release APK
        run: flutter build apk --release --split-per-abi

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/flutter-v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Flutter App v${{ steps.get_version.outputs.VERSION }}
          files: |
            flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            flutter_app_storj_uploader/build/app/outputs/flutter-apk/app-x86_64-release.apk
          draft: false
          prerelease: false
          body: |
            # Flutter Storj Uploader v${{ steps.get_version.outputs.VERSION }}

            ## Download

            Choose the APK for your device architecture:
            - **arm64-v8a**: Modern 64-bit ARM devices (most common)
            - **armeabi-v7a**: Older 32-bit ARM devices
            - **x86_64**: Intel/AMD 64-bit devices (rare)

            If unsure, download **arm64-v8a**.

            ## Features

            - Upload images, videos, and documents to Storj storage
            - Material Design 3 UI with light/dark themes
            - File picker with camera/gallery integration
            - Upload queue management
            - System status monitoring

            ## Requirements

            - Android 7.0 (API 24) or higher
            - Internet connection for uploads
            - Storage permission for file access

            ## Installation

            1. Download the appropriate APK for your device
            2. Enable "Install from Unknown Sources" in Android settings
            3. Open the APK file and follow installation prompts
            4. Grant required permissions when prompted

            ## Configuration

            The app connects to Azure production backend by default.
            You can change the API URL in the app settings if needed.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  quality:
    name: Flutter Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter_app_storj_uploader

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze > flutter-analyze.txt 2>&1 || true

      - name: Run Flutter format check
        run: flutter format --set-exit-if-changed . > flutter-format.txt 2>&1 || true

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flutter-quality-reports
          path: |
            flutter_app_storj_uploader/flutter-analyze.txt
            flutter_app_storj_uploader/flutter-format.txt
          retention-days: 30
